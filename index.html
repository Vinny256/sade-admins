<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sade Net | Admin Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --orange: #FF6600; --bg: #0d0d0d; --card: #1a1a1a; --text: #e0e0e0; --green: #2ecc71; --red: #e74c3c; }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: row; height: 100vh; overflow: hidden; }

        /* --- LOADING ANIMATION (Sade Net Power-Up) --- */
        #server-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 13, 13, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.5s ease;
        }

        .loader-bar-container {
            width: 250px;
            height: 6px;
            background: #222;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
            border: 1px solid #333;
        }

        .loader-progress {
            width: 40%;
            height: 100%;
            background: var(--orange);
            border-radius: 10px;
            animation: moveBar 2s infinite ease-in-out, changeColor 4s infinite;
        }

        @keyframes moveBar {
            0% { transform: translateX(-100%); }
            50% { transform: translateX(150%); }
            100% { transform: translateX(-100%); }
        }

        @keyframes changeColor {
            0% { background: #FF6600; box-shadow: 0 0 10px #FF6600; }
            50% { background: #FF9900; box-shadow: 0 0 20px #FF9900; }
            100% { background: #FF6600; box-shadow: 0 0 10px #FF6600; }
        }

        .loader-text {
            font-size: 0.9rem;
            color: var(--orange);
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- NAVIGATION --- */
        nav { width: 250px; background: var(--card); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 20px; transition: 0.3s; }
        nav .logo { color: var(--orange); font-size: 1.5rem; font-weight: 800; margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        nav a { color: var(--text); text-decoration: none; padding: 15px; border-radius: 8px; margin-bottom: 10px; transition: 0.3s; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        nav a:hover, nav a.active { background: var(--orange); color: white; }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            nav { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; border-right: none; border-bottom: 1px solid #333; position: sticky; top: 0; z-index: 100; }
            nav .logo { display: none; }
            nav a { font-size: 0.8rem; white-space: nowrap; margin-bottom: 0; padding: 10px; }
        }

        /* --- CONTENT AREA --- */
        main { flex: 1; padding: 25px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.5s ease; }

        /* --- DASHBOARD CARDS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border-bottom: 3px solid #333; transition: 0.3s; margin-bottom: 20px; }
        .card:hover { border-color: var(--orange); transform: translateY(-5px); }
        .card h3 { font-size: 0.8rem; color: #888; text-transform: uppercase; margin: 0; }
        .card .value { font-size: 1.8rem; font-weight: bold; margin: 10px 0; color: #fff; }
        .card .sub { font-size: 0.85rem; }

        /* --- TABLES & LISTS --- */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; color: var(--orange); padding: 12px; border-bottom: 1px solid #333; }
        td { padding: 12px; border-bottom: 1px solid #222; font-size: 0.9rem; }
        
        /* --- VOUCHER FACTORY --- */
        .v-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .v-card { background: white; color: black; padding: 15px; border-radius: 8px; text-align: center; border: 2px solid #000; position: relative; }
        .v-card .code { font-size: 1.4rem; font-weight: 800; color: var(--orange); letter-spacing: 2px; }

        .form-input { background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; margin-top: 5px; }
        .btn-action { background: var(--orange); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 10px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- PRINTING --- */
        @media print {
            nav, .card, .btn-action, h1, .analytics-row, #server-loader { display: none !important; }
            main { padding: 0; }
            .v-grid { display: grid !important; grid-template-columns: repeat(3, 1fr) !important; gap: 10mm; }
            .v-card { page-break-inside: avoid; border: 1px solid black; box-shadow: none; }
        }

        /* --- NEW TOAST STYLE --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast { background: var(--card); border-left: 5px solid var(--orange); color: white; padding: 15px 25px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

<div id="server-loader">
    <div class="loader-text">Waking up Sade Server...</div>
    <div class="loader-bar-container">
        <div class="loader-progress"></div>
    </div>
    <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">Render is spinning up (takes ~50s)</p>
</div>

<div id="toast-container"></div>

<nav>
    <div class="logo"><i class="fas fa-wifi"></i> SADE NET</div>
    <a id="nav-dashboard" class="active" onclick="showPage('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</a>
    <a id="nav-vouchers" onclick="showPage('vouchers')"><i class="fas fa-ticket-alt"></i> Vouchers</a>
    <a id="nav-payments" onclick="showPage('payments')"><i class="fas fa-receipt"></i> M-Pesa Sales</a>
    <a id="nav-agents" onclick="showPage('agents')"><i class="fas fa-users"></i> Agents</a>
    <a id="nav-withdraw" onclick="showPage('withdraw')"><i class="fas fa-money-bill-transfer"></i> Withdrawal</a>
</nav>

<main>
    <div id="dashboard" class="section active">
        <h1>Financial Oversight</h1>
        
        <div class="stats-grid">
            <div class="card">
                <h3>Total Sales (Gross)</h3>
                <div class="value" id="total-sales">0/=</div>
                <div class="sub">All M-Pesa Revenue</div>
            </div>
            <div class="card">
                <h3>Founder's Salary (50%)</h3>
                <div class="value" style="color:var(--green)" id="founder-pay">0/=</div>
                <div class="sub">After 10% Agent & 5% Emergency</div>
            </div>
            <div class="card" style="border-bottom-color: #3498db;">
                <h3>Emergency Fund (5%)</h3>
                <div class="value" style="color: #3498db;" id="emergency-fund">0/=</div>
                <div class="sub">Maintenance & Hardware savings</div>
            </div>
            <div class="card">
                <h3>Agent Commissions</h3>
                <div class="value" style="color:var(--red)" id="commissions">0/=</div>
                <div class="sub">Total 10% withheld by shops</div>
            </div>
        </div>

        <div class="analytics-row">
            <div class="chart-box">
                <h3>Today vs Yesterday</h3>
                <div id="comparison-text" style="margin-bottom:10px;">Loading...</div>
                <canvas id="revenueChart" height="150"></canvas>
            </div>
            <div class="leader-box">
                <h3>Top Customers (This Week)</h3>
                <div id="top-customers-list"></div>
            </div>
        </div>
    </div>

    <div id="vouchers" class="section">
        <h1>Voucher Factory</h1>
        <div class="card">
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));">
                <div>
                    <label>Plan</label>
                    <select id="v-plan" class="form-input">
                        <option value="10_sh_1hr" data-price="10">1 HR (10/=)</option>
                        <option value="20_sh_3hr" data-price="20">3 HRS (20/=)</option>
                        <option value="50_sh_24hr" data-price="50">24 HRS (50/=)</option>
                    </select>
                </div>
                <div>
                    <label>Qty</label>
                    <input type="number" id="v-count" class="form-input" value="30">
                </div>
                <div>
                    <label>Shop/Agent</label>
                    <input type="text" id="v-agent" class="form-input" placeholder="Mama Mboga">
                </div>
                <div>
                    <label>Admin Secret</label>
                    <input type="password" id="v-secret" class="form-input">
                </div>
            </div>
            <button class="btn-action" onclick="generateBatch()">Generate & Ready Print</button>
            <button class="btn-action" style="background:#333" onclick="window.print()">üñ®Ô∏è Print Batch</button>
        </div>
        <div id="voucher-output" class="v-grid"></div>
    </div>

    <div id="payments" class="section">
        <h1>Transaction History</h1>
        <div class="card">
            <table id="mpesa-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Amount</th>
                        <th>Receipt</th>
                    </tr>
                </thead>
                <tbody id="mpesa-list"></tbody>
            </table>
        </div>
    </div>

    <div id="agents" class="section">
        <h1>Agent Commissions</h1>
        <div class="card">
            <p>Track how much cash is held by shop agents (10%).</p>
            <table>
                <thead>
                    <tr>
                        <th>Agent Name</th>
                        <th>Vouchers Assigned</th>
                        <th>Total Sales</th>
                        <th>Commission (10%)</th>
                        <th>Debt to Hub</th>
                    </tr>
                </thead>
                <tbody id="agent-list"></tbody>
            </table>
        </div>
    </div>

    <div id="withdraw" class="section">
        <h1>Founder Withdrawal</h1>
        <div class="card" style="max-width: 500px; border-left: 5px solid var(--green);">
            <h3>Request Payout</h3>
            <p style="font-size: 0.8rem; color: #888;">Split: 50% each from Net Earnings (After 15% deductions)</p>
            
            <div class="form-group" style="margin-top: 15px;">
                <label>Amount to Withdraw (Total)</label>
                <input type="number" id="w-amount" class="form-input" placeholder="Enter Even Number">
                <div id="w-split-preview" style="font-size: 0.75rem; margin-top: 5px; color: var(--green);">
                    Split: 0/= each founder
                </div>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label>Admin Secret Key</label>
                <input type="password" id="w-secret" class="form-input">
            </div>

            <button class="btn-action" style="background: var(--green); width: 100%;" onclick="handleWithdrawal()">
                <i class="fas fa-paper-plane"></i> Request Withdrawal
            </button>
        </div>
    </div>
</main>

<script>
    const ADMIN_API = "https://sade-admin-backend.onrender.com"; 

    // TOAST FUNCTION (Replaces Alert)
    function showToast(message, type = 'orange') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.borderLeftColor = type === 'red' ? 'var(--red)' : (type === 'green' ? 'var(--green)' : 'var(--orange)');
        toast.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function showPage(pageId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        const navItem = document.getElementById('nav-' + pageId);
        if(navItem) navItem.classList.add('active');
    }

    async function loadAllData() {
        // Show loader before fetching
        document.getElementById('server-loader').style.display = 'flex';
        document.getElementById('server-loader').style.opacity = '1';

        try {
            console.log("üì° [Sync] Fetching latest Sade Net data...");
            const res = await axios.get(`${ADMIN_API}/api/payments/report`);
            
            if(res.data && res.data.success) {
                updateDashboard(res.data);
                
                if (res.data.transactions && Array.isArray(res.data.transactions)) {
                    updateMpesaLogs(res.data.transactions);
                    updateAgentData(res.data.transactions);
                }

                // Hide loader once data arrives
                setTimeout(() => {
                    const loader = document.getElementById('server-loader');
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                    showToast("Server Awake & Data Synced", "green");
                }, 800);
            }
        } catch (err) { 
            console.error("Data fetch failed", err); 
            document.querySelector('.loader-text').innerText = "Connection Failed";
            document.querySelector('.loader-progress').style.background = "var(--red)";
            showToast("Server is taking too long to wake up...", "red");
        }
    }

    function updateDashboard(data) {
        const gross = data.totalGross;
        const comms = data.agentCommissions;
        const emergency = data.emergencyFund;
        const net = data.netProfit;
        const salary = net / 2;

        document.getElementById('total-sales').innerText = `${gross}/=`;
        document.getElementById('commissions').innerText = `${comms}/=`;
        document.getElementById('emergency-fund').innerText = `${emergency}/=`;
        document.getElementById('founder-pay').innerText = `${salary}/=`;
        document.getElementById('vouchers-sold').innerText = data.count;

        initChart(data.transactions);
        renderTopCustomers(data.transactions);
    }

    function updateMpesaLogs(txs) {
        const list = document.getElementById('mpesa-list');
        // FALLBACK: If mpesaName is missing, call them "Customer"
        list.innerHTML = txs.map(t => `
            <tr>
                <td>${new Date(t.createdAt).toLocaleTimeString()}</td>
                <td>${t.mpesaName || 'Customer'}</td>
                <td>${t.phoneNumber}</td>
                <td>${t.amount}/=</td>
                <td>${t.mpesaReceipt || 'N/A'}</td>
            </tr>
        `).join('');
    }

    function updateAgentData(txs) {
        const agents = {};
        txs.forEach(t => {
            const name = t.agentName || "Direct / Main Hub";
            if(!agents[name]) agents[name] = { count: 0, total: 0 };
            agents[name].count++;
            agents[name].total += t.amount;
        });

        document.getElementById('agent-list').innerHTML = Object.entries(agents).map(([name, stat]) => `
            <tr>
                <td>${name}</td>
                <td>${stat.count}</td>
                <td>${stat.total}/=</td>
                <td>${stat.total * 0.1}/=</td>
                <td style="color:var(--green); font-weight:bold">${stat.total * 0.9}/=</td>
            </tr>
        `).join('');
    }

    // WITHDRAWAL LOGIC
    document.getElementById('w-amount').addEventListener('input', (e) => {
        const val = e.target.value;
        const split = val > 0 ? (val / 2) : 0;
        document.getElementById('w-split-preview').innerText = `Split: ${split}/= each founder`;
    });

    function handleWithdrawal() {
        const amount = parseInt(document.getElementById('w-amount').value);
        const secret = document.getElementById('w-secret').value;

        if(!amount || !secret) {
            return showToast("Please fill all fields", "red");
        }

        if(amount % 2 !== 0) {
            return showToast("Amount must be an even number for a clean split", "red");
        }

        if(secret.length < 4) {
            return showToast("Invalid Secret Key", "red");
        }

        showToast("Withdrawal coming soon... üöÄ", "green");
    }

    // VOUCHER LOGIC
    async function generateBatch() {
        const count = document.getElementById('v-count').value;
        const plan = document.getElementById('v-plan').value;
        const price = document.getElementById('v-plan').selectedOptions[0].getAttribute('data-price');
        const agent = document.getElementById('v-agent').value || "Main Hub";
        const secret = document.getElementById('v-secret').value;

        try {
            const res = await axios.post(`${ADMIN_API}/api/vouchers/generate`, {
                count, plan, amount: price, agentName: agent, secret
            });
            if(res.data.success) {
                showToast(`Successfully generated ${count} vouchers`, "green");
                document.getElementById('voucher-output').innerHTML = res.data.vouchers.map(v => `
                    <div class="v-card">
                        <div style="font-size:0.8rem">SADE NET WIFI</div>
                        <div style="font-weight:bold; margin:5px 0">${v.plan.toUpperCase()}</div>
                        <div class="code">${v.code}</div>
                        <div style="font-size:0.6rem">Login: Connect & Enter Code<br>Support: 0768666068</div>
                    </div>
                `).join('');
            }
        } catch(e) { showToast("Generation Failed. Check Secret Key.", "red"); }
    }

    // CHARTS & CUSTOMERS (Existing Logic)
    function initChart(transactions) {
        if(!transactions || transactions.length === 0) return;
        const todayStr = new Date().toLocaleDateString();
        const yestStr = new Date(Date.now() - 864e5).toLocaleDateString();
        const todayT = transactions.filter(t => new Date(t.createdAt).toLocaleDateString() === todayStr).reduce((a,b)=>a+b.amount, 0);
        const yestT = transactions.filter(t => new Date(t.createdAt).toLocaleDateString() === yestStr).reduce((a,b)=>a+b.amount, 0);
        const diff = todayT - yestT;
        document.getElementById('comparison-text').innerHTML = `Growth: <span style="color:${diff >= 0 ? 'var(--green)' : 'var(--red)'}">${diff}/= vs Yesterday</span>`;
        new Chart(document.getElementById('revenueChart'), {
            type: 'bar',
            data: { labels: ['Yesterday', 'Today'], datasets: [{ label: 'Cash', data: [yestT, todayT], backgroundColor: ['#333', '#FF6600'] }] },
            options: { plugins: { legend: { display: false } } }
        });
    }

    function renderTopCustomers(transactions) {
        if(!transactions) return;
        const group = transactions.reduce((acc, curr) => {
            const n = curr.mpesaName || "Customer";
            acc[n] = (acc[n] || 0) + curr.amount;
            return acc;
        }, {});
        const sorted = Object.entries(group).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById('top-customers-list').innerHTML = sorted.map(([name, total]) => `
            <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #333">
                <span>${name}</span> <span style="color:var(--orange)">${total}/=</span>
            </div>
        `).join('');
    }

    loadAllData();
</script>
</body>
</html>
